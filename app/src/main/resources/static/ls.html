<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/highlightjs-github-theme.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bootstrap-slider.css" crossorigin="anonymous">

    <title>My stocks</title>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js"></script>

    <!-- Generated: http://www.lightstreamer.com/docs/client_javascript_tools/generator.html -->
    <script src="js/lightstreamer.js"></script>
    <script src="js/bootstrap-slider.js"></script>
    <script src="js/modernizr.js"></script>

    <script>
        var myClient = new LightstreamerClient("http://localhost:9090", "WELCOME");
        myClient.addListener({
            onListenStart: function(lsClient) {
                console.log("ON LISTEN START " + lsClient)
            },
            onStatusChange: function(newStatus) {
                console.log("STATUS: " + newStatus);
            },
            onServerError: function(i, errorMessage) {
                console.error("ERROR " + i + " " + errorMessage);
            },
            onPropertyChange: function(property) {
                console.log("PROPERTY " + property + "=" + myClient.connectionDetails[property] || myClient.connectionOptions[property]);
            },
            onListenEnd: function(lsClient) {
                console.log("ON LISTEN END " + lsClient);
            },
            onShareAbort: function(){
                console.log('Share Abort');
            }
        });

        myClient.connect();

        let fields = ["TIMESTAMP", "BID", "ASK", "ASK_SIZE", "BID_SIZE", "SEQ_NUM", "LAST"];
        let listener = {
            onItemUpdate: function (updateInfo) {
                var cells = document.getElementById(updateInfo.getItemName()).cells;
                updateInfo.forEachChangedField(function(fieldName, fieldPos, value) {
                    if ('SEQ_NUM' == fieldName) {
                        cells[1].innerHTML = value;
                    }

                    if ('BID' == fieldName) {
                        cells[2].innerHTML = value;
                    }

                    if ('BID_SIZE' == fieldName) {
                        cells[3].innerHTML = value;
                    }

                    if ('ASK' == fieldName) {
                        cells[4].innerHTML = value;
                    }

                    if ('ASK_SIZE' == fieldName) {
                        cells[5].innerHTML = value;
                    }

                    if ('LAST' == fieldName) {
                        cells[6].innerHTML = value;
                    }

                    if ('TIMESTAMP' == fieldName) {
                        cells[7].innerHTML = value;
                    }
                });
            },
            onSubscriptionError: function(code, message) {
                console.log('Error : ' + code + ' ' + message);
            },
            onEndOfSnapshot: function (itemName, itemPos) {
                console.log('onEndOfSnapshot ' + itemName);
            },
            onItemLostUpdates: function(itemName, itemPos, lostUpdates){
                console.log('onItemLostUpdates ' + itemName + ' ' + itemPos + ' ' + lostUpdates);
            }
        };

        var aapl = new Subscription("MERGE", "STOCK.AAPL", fields);
        aapl.setDataAdapter("STOCK");
        aapl.addListener(listener);
        myClient.subscribe(aapl);

        var ibm = new Subscription("MERGE", "STOCK.IBM", fields);
        ibm.setDataAdapter("STOCK");
        ibm.addListener(listener);
        myClient.subscribe(ibm);

        var epam = new Subscription("MERGE", "STOCK.EPAM", fields);
        epam.setDataAdapter("STOCK");
        epam.addListener(listener);
        myClient.subscribe(epam);
    </script>

    <!--script>
        var svg = d3.select("svg"),
            margin = {top: 20, right: 80, bottom: 30, left: 50},
            width = svg.attr("width") - margin.left - margin.right,
            height = svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    </script-->

    <br>
    <div class="container">
        <div class="row">
            <div class="mx-auto">
                <div class="alert alert-dark" role="alert">
                    <b>Max bandwidth: <span id="bandwidthValue"></span> kB/s</b><br>
                    <input id="bandwidth" data-slider-id='bandwidthSlider' type="text"
                       data-slider-min="1" data-slider-max="500" data-slider-step="1" data-slider-value="100"/>
                </div>
            </div>
        </div>

        <br>

        <div class="row">
            <div class="col-12">
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">SYMBOL</th>
                        <th scope="col">SEQ_NUM</th>
                        <th style="width: 100px" scope="col">BID</th>
                        <th scope="col">BID SIZE</th>
                        <th style="width: 100px" scope="col">ASK</th>
                        <th scope="col">ASK_SIZE</th>
                        <th style="width: 100px" scope="col">LAST</th>
                        <th scope="col">TIMESTAMP</th>
                        <th>MAX FREQUENCY</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr id="STOCK.AAPL">
                        <th>AAPL <span class="badge badge-danger">+7</span> <!-- TODO add to sequence number as increment count --></th>
                        <td>1</td>
                        <td>$100.1</td>
                        <td>10000</td>
                        <td class="table-warning">$105.5</td>
                        <td>12000</td>
                        <td>$103</td>
                        <td>Feb 18, 2017</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <b><span id="aaplFrequencyValue"></span> updates/s</b><br>
                                <input id="frAAPL" data-slider-id='frAAPL' type="text"
                                       data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                       data-slider-value="2"/>
                            </div>
                        </td>
                    </tr>
                    <tr id="STOCK.IBM">
                        <th>IBM</th>
                        <td>1</td>
                        <td>$100.1</td>
                        <td>10000</td>
                        <td class="table-warning">$105.5</td>
                        <td>12000</td>
                        <td>$103</td>
                        <td>Feb 18, 2017</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <b><span id="ibmFrequencyValue"></span> updates/s</b><br>
                                <input id="frIBM" data-slider-id='frIBM' type="text"
                                       data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                       data-slider-value="2"/>
                            </div>
                        </td>
                    </tr>
                    <tr id="STOCK.EPAM">
                        <th>EPAM</th>
                        <td>1</td>
                        <td>$100.1</td>
                        <td>10000</td>
                        <td class="table-warning">$105.5</td>
                        <td>12000</td>
                        <td>$103</td>
                        <td>Feb 18, 2017</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <b><span id="epamFrequencyValue"></span> updates/s</b><br>
                                <input id="frEPAM" data-slider-id='frEPAM' type="text"
                                       data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                       data-slider-value="2"/>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!--button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                    Buy/sell stocks
                </button-->
            </div>

            <!--div class="col-4">
                <h2>Important notifications</h2>
                <div class="alert alert-warning" role="alert">
                    Buy 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Buy 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 100 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Sell 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-danger" role="alert">
                    Error - not enough stocks
                </div>
                <div class="alert alert-warning" role="alert">
                    Buy 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Buy 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 100 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Sell 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-danger" role="alert">
                    Error - not enough stocks
                </div>
            </div-->
        </div>
    </div>

    <script>
        var bandwidth = new Slider('#bandwidth', {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById("bandwidthValue").innerHTML = value;
                if (value > 0) {
                    myClient.connectionOptions.setMaxBandwidth(value * 8); // kB = kb * 8
                }
                return value;
            }
        });

        var frAAPL = new Slider("#frAAPL", {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById("aaplFrequencyValue").innerHTML = value;
                aapl.setRequestedMaxFrequency(value);
                return value;
            }
        });

        var frIBM = new Slider("#frIBM", {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById("ibmFrequencyValue").innerHTML = value;
                ibm.setRequestedMaxFrequency(value);
                return value;
            }
        });

        var frEPAM = new Slider("#frEPAM", {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById("epamFrequencyValue").innerHTML = value;
                epam.setRequestedMaxFrequency(value);
                return value;
            }
        });
    </script>

    <!--svg width="960" height="500"></svg-->

    <!-- Modal -->
    <!--div class="modal fade" id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel2" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel2">AAPL</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <tbody>
                            <tr>
                                <th>BID</th>
                                <td>$120.5</td>
                            </tr>
                            <tr>
                                <th>ASK</th>
                                <td class="table-warning"><b>$120.5</b></td>
                            </tr>
                            <tr>
                                <th>LAST trade price</th>
                                <td>$120.5</td>
                            </tr>
                            <tr>
                                <th>LAST trade amount</th>
                                <td>1000</td>
                            </tr>
                            <tr>
                                <th>Amount of market</th>
                                <td>120,000,000</td>
                            </tr>
                            <tr>
                                <th>Volatility</th>
                                <td>0.58</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div-->

    <!-- Modal -->
    <!--div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Buy/sell stocks</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Symbol">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Quantity">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Buy</button>
                    <button type="button" class="btn btn-success" data-dismiss="modal">Sell</button>
                </div>
            </div>
        </div>
    </div-->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="js/popper.min.js" crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>
</html>