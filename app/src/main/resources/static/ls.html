<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/highlightjs-github-theme.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bootstrap-slider.css" crossorigin="anonymous">

    <title>My stock portfolio</title>
</head>
<body>
    <style>
        * {font-size: 16px;}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js"></script>

    <!-- Generated: http://www.lightstreamer.com/docs/client_javascript_tools/generator.html -->
    <script src="js/lightstreamer.js"></script>
    <script src="js/bootstrap-slider.js"></script>
    <script src="js/modernizr.js"></script>

    <script>
        var myClient = new LightstreamerClient("http://localhost:8080", "WELCOME");
        myClient.addListener({
            onListenStart: function(lsClient) {
                console.log("ON LISTEN START " + lsClient)
            },
            onStatusChange: function(newStatus) {
                console.log("STATUS: " + newStatus);
            },
            onServerError: function(i, errorMessage) {
                console.error("ERROR " + i + " " + errorMessage);
            },
            onPropertyChange: function(property) {
                console.log("PROPERTY " + property + "=" + myClient.connectionDetails[property] || myClient.connectionOptions[property]);
            },
            onListenEnd: function(lsClient) {
                console.log("ON LISTEN END " + lsClient);
            },
            onShareAbort: function(){
                console.log('Share Abort');
            }
        });

        myClient.connect();

        let tableListener = {
            onItemUpdate: function (updateInfo) {
                console.log(updateInfo);

                var cells = document.getElementById(updateInfo.getItemName()).cells;
                updateInfo.forEachChangedField(function(fieldName, fieldPos, value) {
                    if ('SEQ_NUM' == fieldName) {
                        cells[1].innerHTML = value;
                    }

                    if ('BID' == fieldName) {
                        cells[2].innerHTML = value;
                    }

                    if ('BID_SIZE' == fieldName) {
                        cells[3].innerHTML = value;
                    }

                    if ('ASK' == fieldName) {
                        cells[4].innerHTML = value;
                    }

                    if ('ASK_SIZE' == fieldName) {
                        cells[5].innerHTML = value;
                    }

                    if ('LAST' == fieldName) {
                        cells[6].innerHTML = value;
                    }

                    if ('TIMESTAMP' == fieldName) {
                        cells[7].innerHTML = value;
                    }
                });
            },
            onSubscriptionError: function(code, message) {
                console.log('Error : ' + code + ' ' + message);
            },
            onEndOfSnapshot: function (itemName, itemPos) {
                console.log('onEndOfSnapshot ' + itemName);
            },
            onItemLostUpdates: function(itemName, itemPos, lostUpdates){
                console.log('onItemLostUpdates ' + itemName + ' ' + itemPos + ' ' + lostUpdates);
            }
        };
    </script>

    <br>
    <div class="container">
        <div class="row">
            <div class="mx-auto">
                <div class="alert alert-dark" role="alert">
                    <b>Max bandwidth: <span id="bandwidthValue"></span> kB/s</b><br>
                    <input id="bandwidth" data-slider-id='bandwidthSlider' type="text"
                       data-slider-min="1" data-slider-max="500" data-slider-step="1" data-slider-value="100"/>
                </div>
            </div>
        </div>

        <br>

        <div class="row">
            <div class="col-12">
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">SYMBOL</th>
                        <th scope="col">SEQ NUM</th>
                        <th style="width: 100px" scope="col">BID</th>
                        <th scope="col">BID SIZE</th>
                        <th style="width: 100px" scope="col">ASK</th>
                        <th scope="col">ASK SIZE</th>
                        <th style="width: 100px" scope="col">LAST</th>
                        <th scope="col">TIMESTAMP</th>
                        <th style="width: 320px;">MAX FREQUENCY</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr id="STOCK_AAPL">
                        <th>AAPL</th>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="table-warning">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <div class="row">
                                    <div class="col-6">
                                        <b><span id="frSTOCK_AAPL"></span> updates/s</b><br>
                                    </div>
                                    <div class="col-6">
                                        <input id="slSTOCK_AAPL" style="width: 100px;" data-slider-id='slSTOCK_AAPL' type="text"
                                               data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                               data-slider-value="2"/>
                                    </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="STOCK_IBM">
                        <th>IBM</th>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="table-warning">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <div class="row">
                                    <div class="col-6">
                                        <b><span id="frSTOCK_IBM"></span> updates/s</b>
                                    </div>
                                    <div class="col-6">
                                        <input id="slSTOCK_IBM" style="width: 100px;" data-slider-id='frSTOCK_IBM' type="text"
                                               data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                               data-slider-value="2"/>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="STOCK_EPAM">
                        <th>EPAM</th>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="table-warning">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <div class="row">
                                    <div class="col-6">
                                        <b><span id="frSTOCK_EPAM"></span> updates/s</b><br>
                                    </div>
                                    <div class="col-6">
                                        <input id="slSTOCK_EPAM" style="width: 100px;" data-slider-id='frSTOCK_EPAM' type="text"
                                               data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                               data-slider-value="2"/>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="STOCK_TSLA">
                        <th>TSLA</th>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="table-warning">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="alert alert-dark" role="alert">
                                <div class="row">
                                    <div class="col-6">
                                        <b><span id="frSTOCK_TSLA"></span> updates/s</b><br>
                                    </div>
                                    <div class="col-6">
                                        <input id="slSTOCK_TSLA" style="width: 100px;" data-slider-id='frSTOCK_TSLA' type="text"
                                               data-slider-min="1" data-slider-max="100" data-slider-step="1"
                                               data-slider-value="2"/>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!--button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                    Buy/sell stocks
                </button-->
            </div>

            <!--div class="col-4">
                <h2>Important notifications</h2>
                <div class="alert alert-warning" role="alert">
                    Buy 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Buy 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 100 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Sell 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-danger" role="alert">
                    Error - not enough stocks
                </div>
                <div class="alert alert-warning" role="alert">
                    Buy 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Buy 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 100 AAPL shares - order sent
                </div>
                <div class="alert alert-success" role="alert">
                    Sell 100 AAPL shares - success
                </div>
                <div class="alert alert-warning" role="alert">
                    Sell 1000 AAPL shares - order sent
                </div>
                <div class="alert alert-danger" role="alert">
                    Error - not enough stocks
                </div>
            </div-->
        </div>
    </div>

    <script>
        // Init bandwidth slider
        new Slider('#bandwidth', {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById("bandwidthValue").innerHTML = value;
                if (value > 0) {
                    myClient.connectionOptions.setMaxBandwidth(value * 8); // kB = kb * 8
                }
                return value;
            }
        });
    </script>

    <script>
        let fields = ["TIMESTAMP", "BID", "ASK", "ASK_SIZE", "BID_SIZE", "SEQ_NUM", "LAST"];
        let stocks = ['STOCK_AAPL', 'STOCK_IBM', 'STOCK_EPAM', 'STOCK_TSLA'];

        // Prepare subscriptions and sliders
        var subscriptions = stocks.map(function(s) {
            let sub = new Subscription('MERGE', s, fields);
            sub.setDataAdapter('STOCK');
            sub.addListener(tableListener);

            new Slider('#sl' + s, {
                tooltip: 'always',
                formatter: function(value) {
                    document.getElementById('fr' + s).innerHTML = value;
                    sub.setRequestedMaxFrequency(value);
                    return value;
                }
            });

            return sub;
        });

        // Subscribe all
        subscriptions.forEach(function (sub) {
            myClient.subscribe(sub);
        })
    </script>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="js/popper.min.js" crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>
</html>