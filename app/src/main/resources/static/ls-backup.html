<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/highlightjs-github-theme.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bootstrap-slider.css" crossorigin="anonymous">

    <title>My stock portfolio</title>
</head>
<body>
<style>
    * {font-size: 16px;}

    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .graph .axis {
        stroke-width: 1;
    }

    .graph .axis .tick line {
        stroke: black;
    }

    .graph .axis .tick text {
        fill: black;
        font-size: 0.7em;
    }

    .graph .axis .domain {
        fill: none;
        stroke: black;
    }

    .graph .group {
        fill: none;
        stroke: black;
        stroke-width: 1.5;
    }
</style>
<script src="js/d3.v3.min.js"></script>
<script src="js/lodash.js"></script>
<!-- Generated: http://www.lightstreamer.com/docs/client_javascript_tools/generator.html -->
<script src="js/lightstreamer.js"></script>
<script src="js/bootstrap-slider.js"></script>
<script src="js/modernizr.js"></script>
<script src="js/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="js/popper.min.js" crossorigin="anonymous"></script>
<script src="js/bootstrap.min.js" crossorigin="anonymous"></script>

<script>
    let myClient = new LightstreamerClient("http://localhost:9090", "WELCOME");
    myClient.setReverseHeartbeatInterval(1000); // 100 ms
    myClient.setStalledTimeout(5000);
    myClient.setSlowingEnabled(true);

    myClient.addListener({
        onListenStart: (lsClient) => { console.log(`ON LISTEN START ${lsClient}`); },
        onStatusChange: (newStatus) => { console.log(`STATUS:  ${newStatus}`); },
        onServerError: (i, errorMessage) => { console.error(`ERROR ${i} ${errorMessage}`); },
        onPropertyChange: function(property) {
            if(property === 'maxBandwidth') {
                console.log("PROPERTY " + property + "=" + myClient.connectionOptions.getMaxBandwidth());
            } else {
                console.log('PROPERTY changed ' + property);
            }
        },
        onListenEnd: (lsClient) => { console.log(`ON LISTEN END ${lsClient}`); },
        onShareAbort: () => {console.log('Share Abort');}
    });

    myClient.connect();

    const stocks = ['STOCK_AAPL', 'STOCK_IBM', 'STOCK_EPAM', 'STOCK_TSLA'];
    const fields = ['SEQ_NUM', 'BID', 'BID_SIZE', 'ASK', 'ASK_SIZE', 'LAST', 'TIMESTAMP'];

    let tableListener = {
        onItemUpdate: (updateInfo) => {

            let cells = document.getElementById(updateInfo.getItemName()).cells;
            updateInfo.forEachChangedField((fieldName, fieldPos, value) => {
                let index = fields.indexOf(fieldName);
                if (index > -1) {
                    cells[index + 1].innerHTML = fieldName === 'TIMESTAMP' ? new Date(+value).toLocaleTimeString() : value;
                }
            });
        },
        onSubscriptionError: function(code, message) {
            console.log('Error : ' + code + ' ' + message);
        },
        onEndOfSnapshot: function (itemName, itemPos) {
            console.log('onEndOfSnapshot ' + itemName);
        },
        onItemLostUpdates: function(itemName, itemPos, lostUpdates){
            console.log('onItemLostUpdates ' + itemName + ' ' + itemPos + ' ' + lostUpdates);
        }
    };
</script>

<br>

<div class="container">
    <div class="row">
        <div class="col-9">
            <div class="graph"></div>
        </div>
        <div class="col-3">
            <div class="alert alert-dark" style="width: 250px;" role="alert">
                <b>Max bandwidth: <span id="bandwidthValue"></span> kbit/s</b><br>
                <input id="bandwidth" type="range" min="1" max="4000" step="1">
            </div>
            <span class="badge badge-primary">AAPL</span><br>
            <span class="badge badge-danger">IBM</span><br>
            <span class="badge badge-success">EPAM</span><br>
            <span class="badge badge-dark">TSLA</span>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <table class="table">
                <thead>
                <tr>
                    <th scope="col">SYMBOL</th>
                    <th scope="col">SEQ NUM</th>
                    <th style="width: 100px" scope="col">BID</th>
                    <th scope="col">BID SIZE</th>
                    <th style="width: 100px" scope="col">ASK</th>
                    <th scope="col">ASK SIZE</th>
                    <th style="width: 100px" scope="col">LAST</th>
                    <th scope="col">TIMESTAMP</th>
                    <th style="width: 320px;">MAX FREQUENCY</th>
                </tr>
                </thead>
                <tbody>
                <tr id="STOCK_AAPL">
                    <th>AAPL</th>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="table-warning">-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>
                        <div class="alert alert-dark" role="alert">
                            <div class="row">
                                <div class="col-6">
                                    <b><span id="frSTOCK_AAPL"></span> updates/s</b><br>
                                </div>
                                <div class="col-6">
                                    <input id="slSTOCK_AAPL" style="width: 100px;" data-slider-id='slSTOCK_AAPL' type="text"
                                           data-slider-min="0.1" data-slider-max="20" data-slider-step="0.1"
                                           data-slider-value="0.5"/>
                                </div>
                            </div>
                    </td>
                </tr>
                <tr id="STOCK_IBM">
                    <th>IBM</th>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="table-warning">-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>
                        <div class="alert alert-dark" role="alert">
                            <div class="row">
                                <div class="col-6">
                                    <b><span id="frSTOCK_IBM"></span> updates/s</b>
                                </div>
                                <div class="col-6">
                                    <input id="slSTOCK_IBM" style="width: 100px;" data-slider-id='frSTOCK_IBM' type="text"
                                           data-slider-min="0.1" data-slider-max="20" data-slider-step="0.1"
                                           data-slider-value="0.5"/>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr id="STOCK_EPAM">
                    <th>EPAM</th>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="table-warning">-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>
                        <div class="alert alert-dark" role="alert">
                            <div class="row">
                                <div class="col-6">
                                    <b><span id="frSTOCK_EPAM"></span> updates/s</b><br>
                                </div>
                                <div class="col-6">
                                    <input id="slSTOCK_EPAM" style="width: 100px;" data-slider-id='frSTOCK_EPAM' type="text"
                                           data-slider-min="0.1" data-slider-max="20" data-slider-step="0.1"
                                           data-slider-value="0.5"/>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr id="STOCK_TSLA">
                    <th>TSLA</th>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="table-warning">-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>
                        <div class="alert alert-dark" role="alert">
                            <div class="row">
                                <div class="col-6">
                                    <b><span id="frSTOCK_TSLA"></span> updates/s</b><br>
                                </div>
                                <div class="col-6">
                                    <input id="slSTOCK_TSLA" style="width: 100px;" data-slider-id='frSTOCK_TSLA' type="text"
                                           data-slider-min="0.1" data-slider-max="20" data-slider-step="0.1"
                                           data-slider-value="0.5"/>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!--button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                Buy/sell stocks
            </button-->
        </div>

        <!--div class="col-4">
            <h2>Important notifications</h2>
            <div class="alert alert-warning" role="alert">
                Buy 1000 AAPL shares - order sent
            </div>
            <div class="alert alert-success" role="alert">
                Buy 100 AAPL shares - success
            </div>
            <div class="alert alert-warning" role="alert">
                Sell 100 AAPL shares - order sent
            </div>
            <div class="alert alert-success" role="alert">
                Sell 100 AAPL shares - success
            </div>
            <div class="alert alert-warning" role="alert">
                Sell 1000 AAPL shares - order sent
            </div>
            <div class="alert alert-danger" role="alert">
                Error - not enough stocks
            </div>
            <div class="alert alert-warning" role="alert">
                Buy 1000 AAPL shares - order sent
            </div>
            <div class="alert alert-success" role="alert">
                Buy 100 AAPL shares - success
            </div>
            <div class="alert alert-warning" role="alert">
                Sell 100 AAPL shares - order sent
            </div>
            <div class="alert alert-success" role="alert">
                Sell 100 AAPL shares - success
            </div>
            <div class="alert alert-warning" role="alert">
                Sell 1000 AAPL shares - order sent
            </div>
            <div class="alert alert-danger" role="alert">
                Error - not enough stocks
            </div>
        </div-->
    </div>
</div>

<script>
    const limit = 1200,  // points at the chart for a line
        interval = 20 * 1000, //
        now = Date.now(),
        startTime = new Date(now - interval);

    const width = 800,
        height = 300;

    const groups = {
        STOCK_AAPL: {
            value: 0,
            color: 'blue',
            data: d3.range(limit).map(() => {return {value:0, time: startTime}})
        },
        STOCK_IBM: {
            value: 0,
            color: 'red',
            data: d3.range(limit).map(() => {return {value:0, time: startTime}})
        },
        STOCK_EPAM: {
            value: 0,
            color: 'green',
            data: d3.range(limit).map(() => {return {value:0, time: startTime}})
        },
        STOCK_TSLA: {
            value: 0,
            color: 'black',
            data: d3.range(limit).map(() => {return {value:0, time: startTime}})
        }
    };

    const x = d3.time.scale()
        .domain([startTime, new Date(now)])
        .range([0, width]);

    const y = d3.scale.linear()
        .domain([0, 100])
        .range([height, 0]);

    const line = d3.svg.line()
        .x((d) => {
            let xValue = x(d.time);
            return xValue > width ? width : xValue|| 0;
        })
        .y((d) => y(d.value));

    const svg = d3.select('.graph').append('svg')
        .attr('class', 'chart')
        .attr('width', width)
        .attr('height', height + 50);

    const axis = svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(x.axis = d3.svg.axis().scale(x).orient('bottom'));

    const paths = svg.append('g');

    for (let name in groups) {
        let group = groups[name];
        group.path = paths.append('path')
            .data([group.data])
            .attr('class', name + ' group')
            .style('stroke', group.color);
    }

    function update(stockName, value, time) {
        let date = new Date(+time);

        for (let name in groups) {
            // Add new values
            let group = groups[name],
                lastItem = group.data[group.data.length - 1],
                updated = stockName === name ? {time: date, value: value}: lastItem ;

            if (lastItem.time === startTime){
                lastItem.time = date;
            }

            group.data.push(updated);
            group.path.attr('d', line);
        }

        // Shift domain
        x.domain([new Date(+time - interval), new Date(+time)]);

        // Slide x-axis left
        axis.transition()
            .duration(500)
            .ease('ease-out')
            .call(x.axis);

        paths.transition().duration(500).ease('linear');

        // Remove oldest data point from each group
        for (let name in groups){
            groups[name].data.shift();
        }
    }

    // const updateThrottled = _.throttle(update, duration);
    const d3Listener = {
        onItemUpdate: (updateInfo) => {
            update(updateInfo.getItemName(), updateInfo.getValue('ASK'), updateInfo.getValue('TIMESTAMP'));
        }
    };
</script>

<script>
    // Init bandwidth slider
    $('#bandwidth').change((e) => {
        let value = +e.target.value;
        if (value > 0) {
            document.getElementById('bandwidthValue').innerHTML = '' + value;
            myClient.connectionOptions.setMaxBandwidth(value);
        }
    });
</script>

<script>
    // Prepare subscriptions and sliders
    const subscriptions = stocks.map(function(s) {
        let sub = new Subscription('MERGE', s, fields);
        sub.setDataAdapter('STOCK');
        sub.addListener(tableListener);
        sub.addListener(d3Listener);

        new Slider('#sl' + s, {
            tooltip: 'always',
            formatter: function(value) {
                document.getElementById('fr' + s).innerHTML = value;
                sub.setRequestedMaxFrequency(value);
                return value;
            }
        });

        return sub;
    });

    // Subscribe all
    subscriptions.forEach((sub) => myClient.subscribe(sub));
</script>

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="js/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="js/popper.min.js" crossorigin="anonymous"></script>
<script src="js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>
</html>